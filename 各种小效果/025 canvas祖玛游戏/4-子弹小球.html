<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <title>4 子弹小球</title>
    <style>
    canvas {
        position: absolute;
        left: 30%;
        background-color: #eee;
    }
    </style>
</head>

<body>
    <canvas id="myCanvas" width="500" height="500"></canvas>
    <script>
    var oCanvas = document.querySelector('#myCanvas');
    var ctx = oCanvas.getContext('2d');
    var angle = 0; //青蛙、子弹旋转角度
    var ball = []; //存所有小球
    var aColor = ['crimson', 'coral', 'hotpink', 'lightcyan', '#abc', '#bac']; //小球的所有颜色
    var bullet = []; //存所有子弹小球
    setInterval(moveBullet, 1000 / 60); //按'每秒60帧'移动子弹
    setInterval(addBall, 800); //每1s增加一个球
    setInterval(moveBall, 1000 / 60); //按'每秒60帧'移动小球
    var oImg = new Image();
    oImg.onload = function() {
        setInterval(draw, 1000 / 60); //按'每秒60帧的速度'画画
    };
    oImg.src = '蛙.png';
    oCanvas.onmousemove = function(ev) { //每次移动鼠标，改变angle(青蛙 子弹的方向)
        var a = ev.clientX - oCanvas.getBoundingClientRect().left - oCanvas.width / 2;
        var b = oCanvas.height / 2 - ev.clientY + oCanvas.getBoundingClientRect().top;
        if (b >= 0) {
            angle = Math.atan(a / b);
        } else {
            angle = Math.atan(a / b) + Math.PI;
        }
    };
    oCanvas.onclick = function() { //每次点击时，添加子弹
        var newBullet = {
            x: 250,
            y: 250,
            length: 0,
            angle: angle,
            color: aColor[Math.floor(Math.random() * aColor.length)]
        };
        bullet.push(newBullet);
    };

    function addBall() {
        var newBall = {
            x: 250,
            y: 50,
            color: aColor[Math.floor(Math.random() * aColor.length)],
            angle: 0
        };
        ball.push(newBall);
    }

    function moveBall() {
        for (let i = 0; i < ball.length; i++) {
            ball[i].angle += 0.2;
            if (ball[i].angle > 270 + 180) {
                alert('GAME OVER');
                window.location.reload();
            }
            if (ball[i].angle >= 270) {
                ball[i].x = 200 + 150 * Math.sin(ball[i].angle * Math.PI / 180);
                ball[i].y = 250 - 150 * Math.cos(ball[i].angle * Math.PI / 180);
            } else {
                ball[i].x = 250 + 200 * Math.sin(ball[i].angle * Math.PI / 180);
                ball[i].y = 250 - 200 * Math.cos(ball[i].angle * Math.PI / 180);
            }
        }
    }

    function moveBullet() {
        for (let i = 0; i < bullet.length; i++) {
            bullet[i].length += 0.2;
            bullet[i].x = bullet[i].x + bullet[i].length * Math.sin(bullet[i].angle);
            bullet[i].y = bullet[i].y - bullet[i].length * Math.cos(bullet[i].angle);
        }
    }

    function draw() {
        //先清空画布
        ctx.clearRect(0, 0, oCanvas.width, oCanvas.height);

        //画青蛙
        ctx.save();
        ctx.translate(oCanvas.width / 2, oCanvas.height / 2);
        ctx.rotate(angle);
        ctx.translate(-oCanvas.width / 2, -oCanvas.height / 2);
        ctx.drawImage(oImg, (oCanvas.width - oImg.width) / 2, (oCanvas.height - oImg.height) / 2);
        ctx.restore();

        //画轨迹：半径分别为200 150
        ctx.beginPath();
        ctx.arc(oCanvas.width / 2, oCanvas.height / 2, 200, -Math.PI / 2, Math.PI);
        ctx.arc(oCanvas.width / 2 - 50, oCanvas.height / 2, 150, Math.PI, Math.PI * 2);
        ctx.stroke();

        //画小球
        for (let i = 0; i < ball.length; i++) {
            ctx.beginPath();
            ctx.fillStyle = ball[i].color;
            ctx.arc(ball[i].x, ball[i].y, 20, 0, 2 * Math.PI);
            ctx.fill();
        }
        //画子弹
        for (let i = 0; i < bullet.length; i++) {
            ctx.save();
            ctx.beginPath();
            ctx.fillStyle = bullet[i].color;
            ctx.arc(bullet[i].x, bullet[i].y, 20, 0, 2 * Math.PI);
            ctx.fill();
            ctx.restore();
        }
    }
    </script>
</body>

</html>
